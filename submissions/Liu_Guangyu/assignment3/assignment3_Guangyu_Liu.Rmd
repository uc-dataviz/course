---
title: "Assignment3: Interactive graphics with Gapminder"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
runtime: shiny
---

```{r global, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(stringr)
library(dplyr)
library(plotly)
library(scales)

gdp_eduGap <- read.csv("gdp_eduGap.csv") %>% 
  arrange(year)
mapLegend <- read.csv("mapLegend.csv")

# World map legend, which does not change over time
p2 <- ggplot(map_data("world"), aes(x = long, y = lat, group = group)) +
  geom_polygon(fill = "ivory1", color = "ivory3") +
  theme(legend.position = "none", 
        panel.background = NULL, 
        axis.text = element_blank(), 
        axis.title = element_blank(),
        axis.ticks = element_blank())

# Calculate boundraries of the bubble chart
min_x = min(gdp_eduGap$gdp_per_capita,na.rm = TRUE)
max_x = max(gdp_eduGap$gdp_per_capita, na.rm = TRUE)
min_y = 0
max_y = max(gdp_eduGap$eduyrs_fofm, na.rm = TRUE)

p1 <- ggplot(data = gdp_eduGap, aes(x = gdp_per_capita, y = eduyrs_fofm, size = population)) +
  geom_hline(yintercept = 100, color = "red", linetype = 2, size = 0.5) +
  scale_size_continuous(range = c(0,30)) +
  scale_x_continuous(name = "GDP per capita  ($)", 
                     trans = log2_trans(),
                     breaks = trans_breaks("log2", n = 9, function(x) 250*(2^x))(c(1,300)),
                     position = "right") +
  scale_y_continuous(name = "Gender ratio of years in school (female/male)  (%)") +
  coord_cartesian(
    xlim = c(min_x, max_x),
    ylim = c(min_y, max_y)
  ) +
  theme(legend.position = "none")
```

Column {.sidebar}
--------------------

```{r}
#fillCol(height = 500, flex = c(NA, 1),
#        sidebarLayout(
 #         sidebarPanel(
        navbarPage("Educational Gender Gap and GDP per Capita",
          tabPanel("Graph",
                sidebarLayout(
                  sidebarPanel(
                    selectizeInput(inputId = "inputCountry",
                                label = "Select Countries",
                                choices = gdp_eduGap$country,
                                multiple = TRUE),
          sliderInput(inputId = "inputYear",
                                label = "Year",
                                min = min(gdp_eduGap$year, na.rm = TRUE),
                                max = max(gdp_eduGap$year, na.rm = TRUE),
                                animate = animationOptions(interval = 500, 
                                                           loop = TRUE), 
                                sep = "",
                                step = 1,
                                value = 1970),
          # Auto play
          tags$script("$(document).ready(function(){
              setTimeout(function() {$('.slider-animate-button').click()},500);
                      });"),   
          plotOutput("continentMap", height = 200)
        ),
        mainPanel(
        plotlyOutput("bubbleChart", height = "auto", width = "auto")
        ),
        fluid = TRUE
      )
          )
        )

```

Column {.tabset}
---------------------------

### Educational Gender Gap and GDP per Capita over Time

```{r}
plotlyOutput("bubbleChart", height = "auto", width = "auto")

output$bubbleChart <- renderPlotly({
    # Each year includes 131 countries. Use index rather than filter for optimization
    filterData <- slice(gdp_eduGap, ((input$inputYear - 1970) * 131 + 1):((input$inputYear - 1970 + 1) * 131))
    p1 <- p1 +
      geom_point(data = filterData, aes(text = str_c(paste("Country:", country), 
                                  paste("Population: ", population),
                                  paste("GDP: ", gdp_per_capita),
                                  paste("Edu female % male: ", round(eduyrs_fofm, 2), "%"),
                                  sep = '\n'),
                     fill = "ivory2"), color = "grey17", shape = 21)
    if (!is.null(input$inputCountry)){
      filterData <- filter(filterData, country %in% input$inputCountry)
    }
    p1 <- p1 +
      geom_point(data = filterData, aes(text = str_c(paste("Country:", country), 
                                                      paste("Population: ", population),
                                                      paste("GDP: ", gdp_per_capita),
                                                      paste("Edu female % male: ", round(eduyrs_fofm, 2), "%"),
                                                      sep = '\n'),
                                         fill = continent), color = "grey17", shape = 21) +
      scale_fill_manual(name = "", 
                        values = c("Asia" = "firebrick1", 
                                   "Europe" = "yellow1", 
                                   "Americas" = "green1",
                                   "Africa" = "royalblue1",
                                   "Oceania" = "orchid1",
                                   "NA" = "ivory1"))
    
    ggplotly(p1, tooltip = "text")
  })
  
  # Map legend
  output$continentMap <- renderPlot({
    filterData <- mapLegend
    if (!is.null(input$inputCountry)){
      filterData <- filter(mapLegend, country %in% input$inputCountry)
    }
    p2 +
      geom_polygon(data = filterData, aes(fill = continent), color = NA) +
      scale_fill_manual(values = c("Asia" = "firebrick1", 
                                   "Europe" = "yellow1", 
                                   "Americas" = "green1",
                                   "Africa" = "royalblue1",
                                   "Oceania" = "orchid1"))
  })
```

### Introduction
The average year of schooling of a country is positively associated with its wealth. It is not difficult to understand, as GDP per capita increases, citizens have more money to afford education. Also, when people are poor, parents tend to only send the most "prospective" kids, usually boys, who are more likely to find jobs in the labor market, to school, and keep girls work at home. It is reasonable to expect girls stay longer at school as people get richer. This is generally the trend shown in the graph.      
    
In addition, several interesting point can be tell:
- Lesotho, an African country